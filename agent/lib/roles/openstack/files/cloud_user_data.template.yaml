#cloud-config
chpasswd: {expire: false}
hostname: {{ opts.parms.hostname }}
#manage_etc_hosts: localhost
manage_etc_hosts: false
password: {{ opts.parms.password }}
ssh_authorized_keys: [{{{ opts.parms.sshpubkeys }}}]
ssh_pwauth: true
timezone: Europe/London

packages:
  - nfs-client

runcmd:
  - apt-get install -y nfs-client bridge-utils

  # config bridge br0 on eth0
  - /sbin/ifdown eth0
  - sed -i 's/auto eth0/auto br0/' /etc/network/interfaces
  - sed -i 's/iface eth0/iface br0/' /etc/network/interfaces
  - echo "  bridge_ports eth0" >> /etc/network/interfaces
  - /sbin/ifup br0

  # create veth pair
  - ip link add veth0 type veth peer name veth1
  - brctl addif br0 veth0
  - ip link set dev veth0 up
  - ip link set dev veth1 up
  # veth1 can now be passed to openstack as the external provider interface

  # protect interfaces from overwrite on subsequent reboots
  - chattr +i /etc/network/interfaces

  # mount partout agent
  - mkdir -p /opt/partout/agent
  - echo "192.168.0.64:/home/bev/Documents/Brackets/partout/agent  /opt/partout/agent nfs defaults,ro,nolock,intr 0 0" >> /etc/fstab
  - mount -a

  # install nodejs
  - curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
  - apt-get install -y nodejs

  # run once partout agent to build openstack
  - cd /opt/partout/agent && bin/partout-agent -y --env=openstack --once

