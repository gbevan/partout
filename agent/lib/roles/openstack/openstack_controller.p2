/*
    Partout [Everywhere] - Policy-Based Configuration Management for the
    Data-Driven-Infrastructure.

    Copyright (C) 2016 Graham Lee Bevan <graham.bevan@ntlworld.com>

    This file is part of Partout.

    Partout is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*jslint node: true, nomen: true */
'use strict';
/*global p2*/

// make parent node_modules available to sync'd manifest
module.paths = module.paths.concat(module.parent.paths);

var console = require('better-console'),
    heredoc = require('heredoc'),
    path = require('path'),
    u = require('util'),
    forge = require('node-forge'),
    pfs = p2.require('pfs');

p2

// TODO: move roles into partout itself
.include(path.join(__dirname, 'openstack_service'))
.include(path.join(__dirname, 'openstack_endpoint'))
.include(path.join(__dirname, 'openstack_domain'))
.include(path.join(__dirname, 'openstack_project'))
.include(path.join(__dirname, 'openstack_user'))
.include(path.join(__dirname, 'openstack_role'))
.include(path.join(__dirname, 'openstack_image'))

/**
 * @module openstack_controller
 *
 * @description
 * Role: openstack_controller
 * ================
 * ```javascript
 * p2
 * .openstack_controller('controller', {
 *   ip: 'contoller_ip_address',
 *   mysql_pass: 'password',
 *   rabbit_pass: 'password',
 *   keystone_pass: 'password',
 *   glance_pass: 'password',
 *   admin_user_pass: 'password',
 *   demo_user_pass: 'password',
 *   glance_user_pass: 'password',
 *   nova_db_pass: 'password',
 *   nova_user_pass: 'password',
 *   neutron_db_pass: 'password',
 *   neutron_user_pass: 'password',
 *   cinder_db_pass: 'password',
 *   cinder_user_pass: 'password'
 * })
 * ```
 */
.role('openstack_controller', {
  p2: function (title, opts) {
    p2
    .node(function (f) {
      return f.os_dist_id === 'ubuntu' && p2.hasClass('openstack_controller');
    })


    /////////////////////////////
    // sysctl settings
    .file('/etc/sysctl.d/98-reserved-ports.conf', {
      ensure: 'present',
      content: {template: path.join(__dirname, 'files', 'controller', 'reserved-ports.conf')}
    })

    .on('file:/etc/sysctl.d/98-reserved-ports.conf:changed', function () {
      p2
      .command('sysctl --system')
      ;
    })


    /////////////////////////////
    // MariaDB/MySQL

    // TODO: Passing configs for silent installs needs to be supported by package module
    .command(u.format(heredoc(function () {/*
    echo 'mariadb-server-5.5  mysql-server/root_password  password "%s"' | debconf-set-selections;
    echo 'mariadb-server-5.5  mysql-server/root_password_again  password "%s"' | debconf-set-selections
    */}), opts.mysql_pass, opts.mysql_pass), {
      onlyif: function (f) {
        return !f.installed_packages['mariadb-server'];
      }
    })

    //.package('mariadb-server', {ensure: 'absent'})
    .package('mariadb-server', {ensure: 'present'})
    .package('mariadb-client', {ensure: 'present'})

    .command(heredoc(function () {/*
    echo 'mariadb-server-5.5  mysql-server/root_password  password "********"' | debconf-set-selections;
    echo 'mariadb-server-5.5  mysql-server/root_password_again  password "********"' | debconf-set-selections
    */}), {
      onlyif: '! (debconf-get-selections | grep \'^mariadb-server-5.5.*root_password_again[^*]*\\*\\*\\*\\*\\*\\*\\*\\*\' > /dev/null)'
    })

    .package('python-pymysql')
//    .package('PyMySQL', {
//      ensure: 'present',
//      provider: 'pip'
//    })

    .file('/etc/mysql/mariadb.conf.d/99-openstack.cnf', {
      ensure: 'file',
      content: {template: path.join(__dirname, 'files', 'mysqld_openstack.template')},
      parms: {
        datetime: '' //new Date()  // XXX: force recreate every time - for testing events
      }
    })

    .service('mysql', {
      ensure: 'running',
      enabled: true,
      on: {
        'file:/etc/mysql/mariadb.conf.d/99-openstack.cnf:changed': function () {
          p2
          .service('mysql', {ensure: 'stopped'})
          .service('mysql', {ensure: 'running'})
          .command('mysql_secure_installation', {
            cmd: u.format(heredoc(function () {/*
            sleep 5;
            cd /;
            mysql_secure_installation <<EOF

y
%s
%s
y
y
y
y
EOF
          */}), opts.mysql_pass, opts.mysql_pass)
          })
          ;
        }
      }
    })


    /////////////////////////////
    // MongoDB

    .package('mongodb-server')
    .package('mongodb-clients')
    .package('python-pymongo')

    .file('/etc/mongodb.conf', {
      content: {template: path.join(__dirname, 'files', 'mongodb.conf.template')},
      parms: {
        bind_ip: opts.ip
      }
    })

    .service('mongodb', {
      ensure: 'running',
      enabled: true,
      on: {
        'file:/etc/mongodb.conf:changed': function () {
          p2
          .service('mongodb', {ensure: 'stopped'})
          // rm /var/lib/mongodb/journal/prealloc.*   ???
          .service('mongodb', {ensure: 'running'})
          ;
        }
      }
    })


    /////////////////////////////
    // RabbitMQ

    .package('rabbitmq-server')

//    .service('rabbitmq-server', {
//      ensure: 'running'
//    })

    .on('package:rabbitmq-server:changed', function () {
      p2
      .command('rabbitmqctl add_user openstack \'{{ opts.parms.rabbit_pass }}\'', {
        parms: {
          rabbit_pass: opts.rabbit_pass
        }
      })
      .command('rabbitmqctl set_permissions openstack ".*" ".*" ".*"')
      ;
    })


    /////////////////////////////
    // Memcached

    .package('memcached')
    .package('python-memcache')

    .file('/etc/memcached.conf', {
      content: {template: path.join(__dirname, 'files', 'memcached.conf.template')},
      parms: {
        bind_ip: opts.ip
      }
    })

    .service('memcached', {
      ensure: 'running',
      enabled: true,
      on: {
        'file:/etc/memcached.conf:changed': function () {
          p2
          .service('memcached', {ensure: 'stopped'})
          .service('memcached', {ensure: 'running'})
          ;
        }
      }
    })


    /////////////////////////////
    // Connect to the database

    // XXX: May need
    //      update user set authentication_string=password('whatever'), plugin='mysql_native_password' where user='root';
    .mysql_connect(p2.facts.os_hostname, {
      //host: '127.0.0.1',
      socketPath: '/var/run/mysqld/mysqld.sock',
      user: 'root',
      password: opts.mysql_pass,
      debug: false
//      insecureAuth: false    // NEW
    })

    /////////////////////////////
    // Keystone

//    .mysql_database('keystone', {
//      ensure: 'absent',
//      connection: p2.facts.os_hostname
//    })

    .mysql_database('keystone', {
      ensure: 'present',
    })

    .mysql_grant('keystone localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'keystone.*',
      userspecs: {user: 'keystone', host: 'localhost'},
      identifiedby: opts.keystone_pass
    })

    .mysql_grant('keystone %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'keystone.*',
      userspecs: {user: 'keystone', host: '%'},
      identifiedby: opts.keystone_pass
    })

    .package('keystone')
    .package('apache2')
    .package('libapache2-mod-wsgi')

    .ini_file('/etc/keystone/keystone.conf', {
      cfg: {
        database: {
          connection: 'mysql+pymysql://keystone:{{ opts.parms.keystone_dbpass }}@{{ opts.parms.hostname }}/keystone'
        },
        token: {
          provider: 'fernet'
        }
      },
      parms: {
        hostname: p2.facts.os_hostname,
        keystone_dbpass: opts.keystone_pass
      }
    })

    .on('ini_file:/etc/keystone/keystone.conf:changed', function () {
      p2
      .command('su -s /bin/sh -c "keystone-manage db_sync" keystone')
      .command('keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone')
      .command('keystone-manage credential_setup --keystone-user keystone --keystone-group keystone')
      .command('keystone-manage bootstrap --bootstrap-password {{ opts.parms.admin_user_pass }} --bootstrap-admin-url http://{{ f.os_hostname }}:35357/v3/ --bootstrap-internal-url http://{{ f.os_hostname }}:35357/v3/ --bootstrap-public-url http://{{ f.os_hostname }}:5000/v3/ --bootstrap-region-id RegionOne', {
        parms: {
          admin_user_pass: opts.admin_user_pass
        }
      })
      ;
    })

    .file('/etc/apache2/apache2.conf', {
      ensure: 'present',
      content: {template: path.join(__dirname, 'files', 'apache2.conf.template')}
    })

    .service('apache2', {
      ensure: 'running',
      enabled: true,
      on: {
        'file:/etc/apache2/apache2.conf:changed': function () {
          p2
          .service('apache2', {ensure: 'stopped'})
          .service('apache2', {ensure: 'running'})
          .command('rm -f /var/lib/keystone/keystone.db')
          ;
        }
      }
    })

    // Create client environment scripts
    .file('/root/admin-openrc', {
      ensure: 'present',
      content: {template: path.join(__dirname, 'files', 'admin-openrc.template')},
      mode: '0700',
      owner: 'root',
      group: 'root',
      parms: {
        admin_user_pass: opts.admin_user_pass
      }
    })
    .file('/root/demo-openrc', {
      ensure: 'present',
      content: {template: path.join(__dirname, 'files', 'demo-openrc.template')},
      mode: '0700',
      owner: 'root',
      group: 'root',
      parms: {
        demo_user_pass: opts.demo_user_pass
      }
    })

    .source_env(path.join('/', 'root', 'admin-openrc'))

    // Project Service
    .openstack_project('service', {
      description: 'Service Project',
      domain: 'default',
      ensure: 'present'
    })

    // Project Demo
    .openstack_project('demo', {
      description: 'Demo Project',
      domain: 'default',
      ensure: 'present'
    })

    .openstack_user('demo', {
      password: opts.demo_user_pass,
      domain: 'default',
      ensure: 'present'
    })

    .openstack_role('user', {
      project: 'demo',
      user: 'demo',
      ensure: 'present'
    })

    .ini_file('/etc/keystone/keystone-paste.ini', {
      cfg: {
        'pipeline:public_api': {
          pipeline: function (ov, k) {
            return ov.replace(/ admin_token_auth/, '');
          }
        },
        'pipeline:admin_api': {
          pipeline: function (ov, k) {
            return ov.replace(/ admin_token_auth/, '');
          }
        },
        'pipeline:api_v3': {
          pipeline: function (ov, k) {
            return ov.replace(/ admin_token_auth/, '');
          }
        }
      },
      hash_in_value: true,
      noesc: true
    })

    .source_env('/root/admin-openrc')

    .command('test get openstack token', {
      //cmd: 'openstack token issue -f json'
      cmd: 'openstack token issue'
    }, function (rc, stdout, stderr) {
      if (rc !== 0) {
        //console.error('openstack token #2 rc:', rc, 'stdout:', stdout, 'stderr:', stderr);
        throw new Error(stderr);
      }
    })

    /////////////////////////////
    // Glance

    .mysql_database('glance', {
      ensure: 'present',
    })

    .mysql_grant('glance localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'glance.*',
      userspecs: {user: 'glance', host: 'localhost'},
      identifiedby: opts.glance_pass
    })

    .mysql_grant('glance %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'glance.*',
      userspecs: {user: 'glance', host: '%'},
      identifiedby: opts.glance_pass
    })

    .openstack_user('glance', {
      password: opts.glance_user_pass,
      domain: 'default',
      ensure: 'present'
    })

    .openstack_role('admin', {
      project: 'service',
      user: 'glance',
      ensure: 'present'
    })

    .openstack_service('glance', {
      description: 'OpenStack Image',
      type: 'image',
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/image/public', {
      region: 'RegionOne',
      service_type: 'image',
      interface: 'public',
      url: u.format('http://%s:9292', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/image/internal', {
      region: 'RegionOne',
      service_type: 'image',
      interface: 'internal',
      url: u.format('http://%s:9292', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/image/admin', {
      region: 'RegionOne',
      service_type: 'image',
      interface: 'admin',
      url: u.format('http://%s:9292', p2.facts.os_hostname),
      ensure: 'present'
    })

    .package('glance')

    .ini_file('/etc/glance/glance-api.conf', {
      cfg: {
        database: {
          connection: 'mysql+pymysql://glance:{{ opts.parms.glance_dbpass}}@{{ opts.parms.hostname }}/glance'
        },
        keystone_authtoken: {
          auth_uri: 'http://{{ opts.parms.hostname }}:5000',
          auth_url: 'http://{{ opts.parms.hostname }}:35357',
          memcached_servers: '{{ opts.parms.hostname }}:11211',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          project_name: 'service',
          username: 'glance',
          password: '{{ opts.parms.glance_user_pass}}'
        },
        glance_store: {
          stores: 'file,http',
          default_store: 'file',
          filesystem_store_datadir: '/var/lib/glance/images/'
        },
        paste_deploy: {
          flavor: 'keystone'
        }
      },
      parms: {
        hostname: p2.facts.os_hostname,
        glance_dbpass: opts.glance_pass,
        glance_user_pass: opts.glance_user_pass
      }
    })

    .service('glance-api', {
      ensure: 'running',
      enabled: true,
      on: {
        'ini_file:/etc/glance/glance-api.conf:changed': function () {
          p2
          .command('su -s /bin/sh -c "glance-manage db_sync" glance')
          .service('glance-registry', { ensure: 'stopped'})
          .service('glance-registry', { ensure: 'running'})
          .service('glance-api', { ensure: 'stopped'})
          .service('glance-api', { ensure: 'running'})
          ;
        }
      }
    })

    .ini_file('/etc/glance/glance-registry.conf', {
      cfg: {
        database: {
          connection: 'mysql+pymysql://glance:{{ opts.parms.glance_dbpass}}@{{ opts.parms.hostname }}/glance'
        },
        keystone_authtoken: {
          auth_uri: 'http://{{ opts.parms.hostname }}:5000',
          auth_url: 'http://{{ opts.parms.hostname }}:35357',
          memcached_servers: '{{ opts.parms.hostname }}:11211',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          project_name: 'service',
          username: 'glance',
          password: '{{ opts.parms.glance_user_pass}}'
        }
      },
      parms: {
        hostname: p2.facts.os_hostname,
        glance_dbpass: opts.glance_pass,
        glance_user_pass: opts.glance_user_pass
      }
    })

    .service('glance-registry', {
      ensure: 'running',
      enabled: true,
      on: {
        'ini_file:/etc/glance/glance-registry.conf:changed': function () {
          p2
          //.command('su -s /bin/sh -c "glance-manage db_sync" glance')
          .service('glance-registry', { ensure: 'stopped'})
          .service('glance-registry', { ensure: 'running'})
          //.service('glance-api', { ensure: 'stopped'})
          //.service('glance-api', { ensure: 'running'})
          ;
        }
      }
    })

    // Download and create images
    .openstack_image('cirros', {
      url: 'http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img',
      public: true
    })

    .openstack_image('ubuntu trusty', {
      url: 'https://cloud-images.ubuntu.com/trusty/current/trusty-server-cloudimg-amd64-disk1.img',
      public: true
    })

    .openstack_image('ubuntu xenial', {
      url: 'https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img',
      public: true
    })


    ///////////////////////////////////////
    // COMPUTE

    .mysql_database('nova_api', {
      ensure: 'present',
    })
    .mysql_database('nova', {
      ensure: 'present',
    })

    .mysql_grant('nova_api localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'nova_api.*',
      userspecs: {user: 'nova', host: 'localhost'},
      identifiedby: opts.nova_db_pass
    })
    .mysql_grant('nova_api %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'nova_api.*',
      userspecs: {user: 'nova', host: '%'},
      identifiedby: opts.nova_db_pass
    })

    .mysql_grant('nova localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'nova.*',
      userspecs: {user: 'nova', host: 'localhost'},
      identifiedby: opts.nova_db_pass
    })
    .mysql_grant('nova %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'nova.*',
      userspecs: {user: 'nova', host: '%'},
      identifiedby: opts.nova_db_pass
    })

    .openstack_user('nova', {
      password: opts.nova_user_pass,
      domain: 'default',
      ensure: 'present'
    })

    .openstack_role('admin', {
      project: 'service',
      user: 'nova',
      ensure: 'present'
    })

    .openstack_service('nova', {
      description: 'OpenStack Compute',
      type: 'compute',
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/compute/public', {
      region: 'RegionOne',
      service_type: 'compute',
      interface: 'public',
      url: u.format('http://%s:8774/v2.1/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/compute/internal', {
      region: 'RegionOne',
      service_type: 'compute',
      interface: 'internal',
      url: u.format('http://%s:8774/v2.1/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/compute/admin', {
      region: 'RegionOne',
      service_type: 'compute',
      interface: 'admin',
      url: u.format('http://%s:8774/v2.1/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })

    .package('nova-api')
    .package('nova-conductor')
    .package('nova-consoleauth')
    .package('nova-novncproxy')
    .package('nova-scheduler')

    .ini_file('/etc/nova/nova.conf', {
      cfg: {
        DEFAULT: {
          auth_strategy: 'keystone',
          firewall_driver: 'nova.virt.firewall.NoopFirewallDriver',
          my_ip: '{{ f.os_nics.br0.ipv4.address }}',
          transport_url: 'rabbit://openstack:{{ opts.parms.rabbit_pass }}@{{ f.os_hostname }}',
          use_neutron: 'True'
        },
        api_database: {
          connection: 'mysql+pymysql://nova:{{ opts.parms.nova_db_pass }}@{{ f.os_hostname }}/nova_api'
        },
        database: {
          connection: 'mysql+pymysql://nova:{{ opts.parms.nova_db_pass }}@{{ f.os_hostname }}/nova'
        },
        keystone_authtoken: {
          auth_uri: 'http://{{ f.os_hostname }}:5000',
          auth_url: 'http://{{ f.os_hostname }}:35357',
          memcached_servers: '{{ f.os_hostname }}:11211',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          project_name: 'service',
          username: 'nova',
          password: '{{ opts.parms.nova_user_pass }}'
        },
        glance: {
          api_servers: 'http://{{ f.os_hostname }}:9292'
        },
        neutron: {
          url: 'http://{{ f.os_hostname }}:9696',
          auth_url: 'http://{{ f.os_hostname }}:35357',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          region_name: 'RegionOne',
          project_name: 'service',
          username: 'neutron',
          password: '{{ opts.parms.neutron_user_pass }}',
          service_metadata_proxy: 'True',
          metadata_proxy_shared_secret: '{{ opts.parms.metadata_secret }}'
        },
        oslo_concurrency: {
          lock_path: '/var/lib/nova/tmp'
        },
        vnc: {
          vncserver_listen: '$my_ip',
          vncserver_proxyclient_address: '$my_ip'
        }
      },
      parms: {
        nova_db_pass: opts.nova_db_pass,
        nova_user_pass: opts.nova_user_pass,
        neutron_user_pass: opts.neutron_user_pass,
        rabbit_pass: opts.rabbit_pass,
        metadata_secret: opts.metadata_secret
      }
    })

    .on('ini_file:/etc/nova/nova.conf:changed', function () {
      p2
      .command('populate nova api_db', {
        cmd: heredoc(function () {/*
          su -s /bin/sh -c "nova-manage api_db sync" nova && \
          touch {{{ f.cfg.PARTOUT_VARDIR }}}/populated_nova_api_database
        */}),
        creates: '{{{ f.cfg.PARTOUT_VARDIR }}}/populated_nova_api_database'
      })
      .command('populate nova db', {
        cmd: heredoc(function () {/*
          su -s /bin/sh -c "nova-manage db sync" nova && \
          touch {{{ f.cfg.PARTOUT_VARDIR }}}/populated_nova_database
        */}),
        creates: '{{{ f.cfg.PARTOUT_VARDIR }}}/populated_nova_database'
      })
      .service('nova-api', { ensure: 'stopped' })
      .service('nova-consoleauth', { ensure: 'stopped' })
      .service('nova-scheduler', { ensure: 'stopped' })
      .service('nova-conductor', { ensure: 'stopped' })
      .service('nova-novncproxy', { ensure: 'stopped' })
      ;
    })

    .service('nova-api', { ensure: 'running', enabled: true })
    .service('nova-consoleauth', { ensure: 'running', enabled: true })
    .service('nova-scheduler', { ensure: 'running', enabled: true })
    .service('nova-conductor', { ensure: 'running', enabled: true })
    .service('nova-novncproxy', { ensure: 'running', enabled: true })


    //////////////////////////////////////////
    // NETWORK - Neutron

    .mysql_database('neutron', {
      ensure: 'present',
    })

    .mysql_grant('neutron localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'neutron.*',
      userspecs: {user: 'neutron', host: 'localhost'},
      identifiedby: opts.neutron_db_pass
    })
    .mysql_grant('neutron %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'neutron.*',
      userspecs: {user: 'neutron', host: '%'},
      identifiedby: opts.neutron_db_pass
    })

    .openstack_user('neutron', {
      password: opts.neutron_user_pass,
      domain: 'default',
      ensure: 'present'
    })

    .openstack_role('admin', {
      project: 'service',
      user: 'neutron',
      ensure: 'present'
    })

    .openstack_service('neutron', {
      description: 'OpenStack Networking',
      type: 'network',
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/network/public', {
      region: 'RegionOne',
      service_type: 'network',
      interface: 'public',
      url: u.format('http://%s:9696', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/network/internal', {
      region: 'RegionOne',
      service_type: 'network',
      interface: 'internal',
      url: u.format('http://%s:9696', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/compute/admin', {
      region: 'RegionOne',
      service_type: 'network',
      interface: 'admin',
      url: u.format('http://%s:9696', p2.facts.os_hostname),
      ensure: 'present'
    })

    /*
     * Networking Option 2: Self-Service Networks
     */
    .package('neutron-server')
    .package('neutron-plugin-ml2')
    .package('neutron-linuxbridge-agent')
    .package('neutron-l3-agent')
    .package('neutron-dhcp-agent')
    .package('neutron-metadata-agent')

    .ini_file('/etc/neutron/neutron.conf', {
      cfg: {
        DEFAULT: {
          allow_overlapping_ips: 'True',
          auth_strategy: 'keystone',
          core_plugin: 'ml2',
          notify_nova_on_port_data_changes: 'True',
          notify_nova_on_port_status_changes: 'True',
          service_plugins: 'router',
          transport_url: 'rabbit://openstack:{{ opts.parms.rabbit_pass }}@{{ f.os_hostname }}'
        },
        database: {
          connection: 'mysql+pymysql://neutron:{{ opts.parms.neutron_db_pass }}@{{ f.os_hostname }}/neutron'
        },
        keystone_authtoken: {
          auth_uri: 'http://{{ f.os_hostname }}:5000',
          auth_url: 'http://{{ f.os_hostname }}:35357',
          memcached_servers: '{{ f.os_hostname }}:11211',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          project_name: 'service',
          username: 'neutron',
          password: '{{ opts.parms.neutron_user_pass }}'
        },
        nova: {
          auth_url: 'http://{{ f.os_hostname }}:35357',
          auth_type: 'password',
          project_domain_name: 'default',
          user_domain_name: 'default',
          region_name: 'RegionOne',
          project_name: 'service',
          username: 'nova',
          password: '{{ opts.parms.nova_user_pass }}'
        }
      },
      parms: {
        neutron_db_pass: opts.neutron_db_pass,
        neutron_user_pass: opts.neutron_user_pass,
        rabbit_pass: opts.rabbit_pass,
        nova_user_pass: opts.nova_user_pass
      }
    })

    .ini_file('/etc/neutron/plugins/ml2/ml2_conf.ini', {
      cfg: {
        ml2: {
          extension_drivers: 'port_security',
          mechanism_drivers: 'linuxbridge,l2population',
          tenant_network_types: 'vxlan',
          type_drivers: 'flat,vlan,vxlan'
        },
        ml2_type_flat: {
          flat_networks: 'provider'
        },
        ml2_type_vxlan: {
          vni_ranges: '1:1000'
        },
        securitygroup: {
          enable_ipset: 'True'
        }
      }
    })

    .ini_file('/etc/neutron/plugins/ml2/linuxbridge_agent.ini', {
      cfg: {
        linux_bridge: {
          physical_interface_mappings: 'provider:veth1' // virt provider net bridge to local lan
        },
        securitygroup: {
          enable_security_group: 'True',
          firewall_driver: 'neutron.agent.linux.iptables_firewall.IptablesFirewallDriver'
        },
        vxlan: {
          enable_vxlan: 'True',
          l2_population: 'True',
          local_ip: '{{ f.os_nics.br0.ipv4.address }}'
        }
      }
    })

    .ini_file('/etc/neutron/l3_agent.ini', {
      cfg: {
        DEFAULT: {
          external_network_bridge: '',
          interface_driver: 'neutron.agent.linux.interface.BridgeInterfaceDriver'
        }
      }
    })

    .ini_file('/etc/neutron/dhcp_agent.ini', {
      cfg: {
        DEFAULT: {
          dhcp_driver: 'neutron.agent.linux.dhcp.Dnsmasq',
          enable_isolated_metadata: 'True',
          interface_driver: 'neutron.agent.linux.interface.BridgeInterfaceDriver'
        }
      }
    })

    .ini_file('/etc/neutron/metadata_agent.ini', {
      cfg: {
        DEFAULT: {
          metadata_proxy_shared_secret: '{{ opts.parms.metadata_secret }}',
          nova_metadata_ip: '{{ f.os_hostname }}'
        }
      },
      parms: {
        metadata_secret: opts.metadata_secret
      }
    })

    .command('populate neutron db', {
      cmd: heredoc(function () {/*
        su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
          --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron && \
          touch {{{ f.cfg.PARTOUT_VARDIR }}}/populated_neutron_database
      */}),
      creates: '{{{ f.cfg.PARTOUT_VARDIR }}}/populated_neutron_database'
    })

    .on('command:populate neutron db:changed', function () {
      p2
      .service('nova-api', { ensure: 'stopped'})
      .service('neutron-server', { ensure: 'stopped'})
      .service('neutron-linuxbridge-agent', { ensure: 'stopped'})
      .service('neutron-dhcp-agent', { ensure: 'stopped'})
      .service('neutron-metadata-agent', { ensure: 'stopped'})
      .service('neutron-l3-agent', { ensure: 'stopped'})
      ;
    })

    .service('nova-api', { ensure: 'running', enabled: true})
    .service('neutron-server', { ensure: 'running', enabled: true})
    .service('neutron-linuxbridge-agent', { ensure: 'running', enabled: true})
    .service('neutron-dhcp-agent', { ensure: 'running', enabled: true})
    .service('neutron-metadata-agent', { ensure: 'running', enabled: true})
    .service('neutron-l3-agent', { ensure: 'running', enabled: true})


    //////////////////////////////////////////
    // Horizon Dashboard

    .package('openstack-dashboard')

    .file('/etc/openstack-dashboard/local_settings.py', {
      ensure: 'present',
      content:{template: path.join(__dirname, 'files', 'controller', 'dashboard_local_settings_newton_template.py')}
    })
    .on('file:/etc/openstack-dashboard/local_settings.py:changed', function () {
      p2
      .command('service apache2 reload')
      ;
    })


    ///////////////////////////////////////
    // CINDER

    .mysql_database('cinder', {
      ensure: 'present',
    })

    .mysql_grant('cinder localhost', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'cinder.*',
      userspecs: {user: 'cinder', host: 'localhost'},
      identifiedby: opts.cinder_db_pass
    })
    .mysql_grant('cinder %', {
      ensure: 'present',
      privileges: 'ALL PRIVILEGES',
      privlevel: 'cinder.*',
      userspecs: {user: 'cinder', host: '%'},
      identifiedby: opts.cinder_db_pass
    })

    .openstack_user('cinder', {
      password: opts.cinder_user_pass,
      domain: 'default',
      ensure: 'present'
    })

    .openstack_role('admin', {
      project: 'service',
      user: 'cinder',
      ensure: 'present'
    })

    .openstack_service('cinder', {
      description: 'OpenStack Block Storage',
      type: 'volume',
      ensure: 'present'
    })

    .openstack_service('cinderv2', {
      description: 'OpenStack Block Storage',
      type: 'volumev2',
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/volume/public', {
      region: 'RegionOne',
      service_type: 'volume',
      interface: 'public',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })
    .openstack_endpoint('RegionOne/volume/internal', {
      region: 'RegionOne',
      service_type: 'volume',
      interface: 'internal',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })
    .openstack_endpoint('RegionOne/volume/admin', {
      region: 'RegionOne',
      service_type: 'volume',
      interface: 'admin',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })

    .openstack_endpoint('RegionOne/volumev2/public', {
      region: 'RegionOne',
      service_type: 'volumev2',
      interface: 'public',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })
    .openstack_endpoint('RegionOne/volumev2/internal', {
      region: 'RegionOne',
      service_type: 'volumev2',
      interface: 'internal',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })
    .openstack_endpoint('RegionOne/volumev2/admin', {
      region: 'RegionOne',
      service_type: 'volumev2',
      interface: 'admin',
      url: u.format('http://%s:8776/v2/%\\(tenant_id\\)s', p2.facts.os_hostname),
      ensure: 'present'
    })

    .package('cinder-api')
    .package('cinder-scheduler')
    .package('python-cinderclient')

    .ini_file('/etc/cinder/cinder.conf', {
      cfg: {
        DEFAULT: {
          auth_strategy: 'keystone',
          my_ip: '{{ f.os_nics.br0.ipv4.address }}'
        },
        database: {
          connection: 'mysql://cinder:{{ opts.parms.cinder_db_pass }}@{{ f.os_hostname }}/cinder'
        },
        keystone_authtoken: {
          auth_uri: 'http://{{ f.os_hostname }}:5000',
          auth_url: 'http://{{ f.os_hostname }}:35357',
          memcached_servers: '{{ f.os_hostname }}:11211',
          auth_type: 'password',
          project_domain_id: 'default',
          user_domain_id: 'default',
          project_name: 'service',
          username: 'cinder',
          password: '{{ opts.parms.cinder_user_pass }}'
        },
        oslo_concurrency: {
          lock_path: '/var/lock/cinder'
        }
      },
      parms: {
        cinder_db_pass: opts.cinder_db_pass,
        cinder_user_pass: opts.cinder_user_pass,
        rabbit_pass: opts.rabbit_pass
      }
    })

    .on('ini_file:/etc/cinder/cinder.conf:changed', function () {
      p2
      .service('cinder-scheduler', { ensure: 'stopped'})
      .service('cinder-scheduler', { ensure: 'running'})
      .service('cinder-api', { ensure: 'stopped'})
      .service('cinder-api', { ensure: 'running'})
      ;
    })

    .command('populate block storage db', {
      cmd: heredoc(function () {/*
        su -s /bin/sh -c "cinder-manage db sync" cinder && \
        touch {{{ f.cfg.PARTOUT_VARDIR }}}/populated_cinder_database
      */}),
      creates: '{{{ f.cfg.PARTOUT_VARDIR }}}/populated_cinder_database'
    })

    .on('command:populate block storage db:changed', function () {
      p2
      .service('cinder-scheduler', { ensure: 'stopped'})
      .service('cinder-scheduler', { ensure: 'running'})
      .service('cinder-api', { ensure: 'stopped'})
      .service('cinder-api', { ensure: 'running'})
      .file('/var/lib/cinder/cinder.sqlite', {
        ensure: 'absent'
      })
      ;
    })

    ;
  } // p2
}) // role openstack_controller

;
